from osgeo import osr, ogr
from visuallayer import *

def find_nearest_capitals(source_polygon):
    """
    This class find the nearest capital cities from a given polygon
    """

    #find buffer of the polygon
    buf = source_polygon.Buffer(1)



    driver = ogr.GetDriverByName("ESRI Shapefile")
    file_italy = 'data/capitals/capoluoghi_provincia_2019.shp'
    vector_italy = driver.Open(file_italy, 0)
    layer_italy = vector_italy.GetLayer(0)

    srs_italy = layer_italy.GetSpatialRef()
    target_osr = osr.SpatialReference()
    target_osr.ImportFromEPSG(4326) #WGS84
    #transform = osr.CoordinateTransformation(srs_italy, target_osr)

    nearest_capitals = []
    for capital in layer_italy:
        geom = capital.GetGeometryRef()
        geom.TransformTo(target_osr)

        if (geom.GetGeometryName() == 'POLYGON'):
            geom = transformInLatLonPolygon(geom)

        #plot_geometry(geom, fillcolor='blue', alpha=0.5)
            if geom.Intersect(buf):
                name = capital.GetField('comune')
                plot_geometry(geom, fillcolor='blue', alpha=0.5)
                nearest_capitals.append([name,geom.ExportToWkt()])

    plt.show()
    #Todo: try to return the capitals in order of distance
    return nearest_capitals

def transformInLatLonPolygon(geom):
    pointList = []
    points=[]

    #plot_geometry(g, fillcolor='red', alpha=0.2)
    if (geom.GetGeometryName() == 'POLYGON'):
        g = geom.GetGeometryRef(0)
        for i in range (0, geom.GetGeometryCount()):
            linearring = geom.GetGeometryRef(i)
            new_ring = ogr.Geometry(ogr.wkbLinearRing)
            for j in range(0, linearring.GetPointCount()):
                pt = linearring.GetPoint(j)
                new_ring.AddPoint(pt[1], pt[0])

            poly = ogr.Geometry(ogr.wkbPolygon)
            poly.AddGeometry(new_ring)
    else:
        poly = ogr.Geometry(ogr.wkbPolygon)

    return poly

    #Todo:continue with the other types

    #else:
        #print (g.GetGeometryName())




if __name__ == '__main__':
    wtk_polygon = 'POLYGON ((13.2384007877709 40.8423717968398,13.2333166538173 40.8391758316345,13.1866208404939 40.8131938176129,13.1386037809917 40.7897433158844,13.0894025910988 40.7688912908584,13.0391577679636 40.7506972868276,12.988012788896 40.7352132579356,12.9361137016587 40.7224834198184,12.8836087074187 40.7125441233438,12.8306477375491 40.7054237508095,12.7773820254907 40.7011426348951,12.7239636748953 40.6997130006012,12.6705452252834 40.7011389303402,12.6172792164586 40.7054163522784,12.5643177529201 40.7125330519634,12.5118120695182 40.7224687072037,12.4599120995941 40.7351949460995,12.4087660468353 40.7506754280607,12.3585199620706 40.7688659475798,12.3093173262125 40.7897145604634,12.2612986405383 40.8131617321625,12.21460102548 40.8391405077768,12.1693578290675 40.867576703249,12.1256982461453 40.8983891172021,12.1082192461453 40.9114381172021,12.0676590383275 40.9433816601905,12.0288015408474 40.9773760021675,11.9917503291571 41.0133305305214,11.9566041640171 41.0511494077234,11.9234567282473 41.0907318267849,11.8923963770141 41.1319722799606,11.863505902317 41.1747608399814,11.8368623123058 41.2189834530677,11.812536626013 41.2645222429424,11.7905936840515 41.3112558250322,11.7710919757809 41.3590596300209,11.7540834834021 41.4078062358912,11.7396135433987 41.4573657075709,11.7277207256907 41.5076059432773,11.7184367308265 41.5583930266374,11.7117863054836 41.6095915836447,11.7077871765065 41.6610651435011,11.7064500036549 41.712676502383,11.7077783511905 41.7642880891606,11.7117686783758 41.8157623320965,11.7184103489123 41.8669620255463,11.7276856592916 41.9177506956828,11.7395698859849 41.9679929642699,11.7540313513434 42.0175549095157,11.7710315080362 42.0663044230445,11.790525041799 42.1141115620335,11.8124599922198 42.1608488955785,11.836777891241 42.2063918443639,11.8634139190067 42.2506190127306,11.8825277400767 42.2789381911006,11.8624818562213 42.3058402715267,11.8467249981485 42.3294812179365,11.8108023954198 42.3750657343873,11.7793847054957 42.4171626185096,11.7502208733 42.4608511728989,11.7365366146819 42.4838846472895,11.7363020308661 42.4841985520875,11.7070953542766 42.5278939069591,11.6802247518423 42.5730634179104,11.6557644486043 42.6195823125691,11.6337820116006 42.6673220911414,11.6143381632245 42.716150881369,11.5974866134906 42.7659338028012,11.5832739116705 42.8165333393775,11.5814151223966 42.8247964811322,11.5724587480852 42.8446905075361,11.5535434142536 42.8933401599409,11.5371923735958 42.9429105341827,11.5234501758063 42.9932665718841,11.5123542625822 43.0442710740656,11.5039348656103 43.0957850749556,11.498214924199 43.1476682206132,11.4952100227779 43.1997791513333,11.4949283484368 43.2519758867928,11.4973706686196 43.3041162128868,11.5025303290332 43.3560580692022,11.5103932717776 43.4076599360721,11.5209380736478 43.458781220158,11.5341360045029 43.5092826375065,11.5499511055439 43.5590265930401,11.5683402872859 43.6078775554454,11.5892534469592 43.6557024264389,11.6126336050179 43.7023709034038,11.6384170603852 43.7477558344095,11.666533564012 43.7917335646472,11.6969065102763 43.8341842733374,11.7294531457006 43.8749923001902,11.7640847944207 43.9140464605319,11.80070709979 43.9512403482355,11.8392202814614 43.986472625633,11.8914292814614 44.031788625633,11.9320445194695 44.0652098702144,11.9743608662305 44.0964493315515,12.0182612503065 44.1254205832642,12.0636242178981 44.1520434741498,12.1103242688559 44.1762443499267,12.158232203886 44.1979562570049,12.2072154819902 44.2171191277186,12.2571385871507 44.2336799465076,12.3078634032456 44.2475928965889,12.3179848517682 44.2498041784058,12.3327258323836 44.2605103956198,12.3757346420449 44.2900644099936,12.4202266203997 44.3173345646718,12.4272083477444 44.3211276704548,12.4480100706851 44.3449991529663,12.4843556963665 44.3825524460172,12.5226136051303 44.4181556304555,12.562679304898 44.4517114649298,12.6044433660536 44.483128299922,12.6477917203245 44.5123203280656,12.6926059723306 44.5392078185075,12.7511659723306 44.5722928185075,12.7975475641122 44.5969137600052,12.8451576419895 44.6190660353047,12.8938649238952 44.6386885607735,12.9435351022849 44.6557272284197,12.994031214482 44.6701350550918,13.0452140203444 44.6818723120314,13.0969423862121 44.6909066344237,13.1490736740739 44.6972131106415,13.2014641348849 44.7007743509371,13.253969304945 44.7015805353941,13.3064444042504 44.6996294410048,13.3587447357154 44.6949264478007,13.4107260841666 44.6874845240163,13.4622451140083 44.6773241903311,13.5131597644617 44.6644734632842,13.5633296412896 44.6489677780206,13.6094366520968 44.6320187720944,13.6452191973924 44.634597578291,13.698159422638 44.635602953881,13.7510786499524 44.6338047298742,13.8038285108501 44.6292079479121,13.8562611116944 44.6218254958921,13.908229448344 44.6116780718343,13.9595878183047 44.5987941258506,14.0101922292328 44.5832097803799,14.0599008026431 44.5649687289122,14.1085741716904 44.5441221134864,14.1560758719098 44.5207283813044,14.2022727238184 44.4948531208638,14.2470352063082 44.4665688780689,14.2902378197816 44.4359549528356,14.3317594380119 44.4030971767594,14.3714836477419 44.3680876724718,14.4092990750696 44.3310245953579,14.4763080750696 44.2617765953579,14.5114474157084 44.2235231490402,14.5445530142252 44.1834966732703,14.5755355484241 44.1418051634591,14.6043114243474 44.0985611074449,14.6308030018214 44.05388118199,14.6549388039361 44.0078859379751,14.6766537098981 43.9606994751411,14.6958891307323 43.912449107256,14.7125931673609 43.8632650186091,14.7267207506325 43.8132799127613,14.738233762923 43.7626286544974,14.7471011409805 43.7114479059478,14.7532989597375 43.6598757578602,14.7568104968629 43.6080513570172,14.7576262778804 43.5561145308045,14.7557441017317 43.5042054099426,14.7511690467151 43.4524640504,14.743913456784 43.4010300555088,14.7339969082413 43.3500421993006,14.7214461569208 43.2996380520802,14.7062950659974 43.2499536092481,14.6885845146205 43.2011229243702,14.6835458709646 43.1892016460197,14.6925276265835 43.1573146011142,14.7040979488108 43.106056697399,14.7129597493427 43.0542617792984,14.7190885585764 43.0020728652736,14.7224674533676 42.949634061705,14.72308710376 42.8970901649795,14.7229357070939 42.8933779820511,14.7447356725906 42.8688021832124,14.7771740540513 42.8281598943604,14.8074558762631 42.7858863153961,14.8354992558393 42.742095755947,14.8566720966167 42.7049089915122,14.857406699338 42.7049372719293,14.9102310523021 42.7041788005738,14.9629416333039 42.7006316615406,15.0106123363462 42.6948821443628,15.0158027316809 42.6949474464775,15.0688506409326 42.6927969250147,15.121709652834 42.6878340347944,15.174230773402 42.6800727647423,15.2262659610693 42.6695349915923,15.2776685439705 42.6562504182227,15.3282936333668 42.6402564899325,15.3779985320443 42.6215982888939,15.4266431365357 42.6003284070793,15.4740903320308 42.5765067980199,15.5202063788627 42.5502006078142,15.5648612894801 42.5214839858631,15.6079291948445 42.4904378758644,15.6492886992179 42.4571497876566,15.688823222341 42.4217135505544,15.7264213280393 42.3842290488713,15.7619770383285 42.3448019403753,15.7953901321355 42.3035433584706,15.8265664277916 42.2605695989458,15.8554180485034 42.2160017921697,15.8818636700512 42.1699655616606,15.9058287500182 42.122590669991,15.9272457379038 42.0740106530247,15.946054265528 42.0243624435188,15.9622013171922 41.9737859851505,15.9756413791144 41.9224238380569,15.9863365677192 41.8704207770004,15.9942567364205 41.8179233832911,15.9993795605958 41.7650796316169,16.0000815605958 41.7550806316169,16.0023673129211 41.7034673290562,16.001984360503 41.6518048570638,15.9989337255019 41.600231110923,15.9932235505436 41.5488837490934,15.9848690769855 41.4978998257794,15.9738926042346 41.4474154251109,15.9603234302272 41.3975652979127,15.9441977732283 41.3484825020341,15.9255586751588 41.3002980471957,15.9044558867101 41.2531405453046,15.8809457345518 41.2071358671685,15.8550909709868 41.1624068065266,15.8269606064554 41.1190727522938,15.7966297253357 41.0772493698934,15.7641792855315 41.0370482925269,15.7296959023829 40.9985768232081,15.6932716174764 40.9619376483544,15.6550036529713 40.9272285636999,15.6149941520983 40.8945422132642,15.5733499065233 40.86396584207,15.5301820713037 40.8355810632728,15.4856058681976 40.8094636403226,15.4397402781193 40.785683284739,15.3927077235601 40.7643034700403,15.3446337418235 40.7453812623229,15.2985229564514 40.729930931347,15.2699233592531 40.699766967816,15.2320488835985 40.6637859516115,15.1923470511673 40.6298319542795,15.1509262126048 40.5979976399944,15.1078994099124 40.5683698880837,15.0633840679432 40.5410295559245,15.0175016739368 40.5160512582752,14.9703774459675 40.4935031636436,14.9221399912104 40.4734468082474,14.8729209549584 40.4559369280754,14.8228546613475 40.4410213095067,14.772077746772 40.4287406588966,14.7207287869883 40.4191284914846,14.6689479189271 40.4122110399275,14.6168764582438 40.4080071827074,14.564656513653 40.4065283926109,14.5124305990981 40.4077787054179,14.4776011922119 40.4104372494629,14.4612082396068 40.4058539605011,14.4103631167348 40.3944565196686,14.3589933357524 40.3857230335818,14.3072383721995 40.3796772147747,14.2552387474361 40.3763354784206,14.2031356471083 40.3757068977617,14.1510705378122 40.3777931794754,14.099184782993 40.3825886590392,14.0476192591257 40.3900803161114,13.996513973217 40.400247809883,13.9460076826687 40.413063534305,13.8962375185335 40.4284926930429,13.8473386131864 40.4464933939531,13.7994437334231 40.4670167628253,13.7526829199813 40.4900070760825,13.5362959199813 40.6034890760825,13.4904107209473 40.6291125082446,13.4459350601486 40.6571112111196,13.4029917798837 40.6874078519606,13.3616994899981 40.7199187510893,13.3221722402821 40.7545541130197,13.2845192054645 40.7912182744745,13.2488443836707 40.8298099686086,13.2384007877709 40.8423717968398))'
    polygon = ogr.CreateGeometryFromWkt(wtk_polygon)

    plot_geometry(polygon, fillcolor='grey', alpha=0.2)
    capitals = find_nearest_capitals(polygon)
    for capital in capitals:
        print (capital)